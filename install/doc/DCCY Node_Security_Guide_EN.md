# DCCY Access Security Guide

This guide aims to help project parties to securely connect with DCCY tokens, ensure the security and stability of DCCY deposit and withdrawal services, and the security of DCCY nodes.

## Exchange recharge withdrawal plan

### Basic logic

**Recharge：** The exchange needs to generate a uniquely identifiable identifier in the platform for the account recharged in the exchange. When a user recharges to the exchange account, the unique identifier generated by the exchange platform for the user must be filled in the memo field of the transfer operation.

**withdraw：** The user fills in his DCCY account when withdrawing money, and the exchange transfers the amount of DCCY withdrawn by the user to the account name filled by the user through transfer to complete the withdrawal. In this process, the memo field may also be necessary because users may withdraw from one exchange to another.

### Precautions

#### DCCY transfer types：

There are two types of transfer functions in the DCCY network：`transfer` 和 `extransfer`

**transfer**

The `transfer` function represents the transfer method, and the function prototype is：

```
void transfer(account_name from, account_name to, asset quantity, string memo)
```

Example:

```
transfer('accountfrom', 'accountto', '1.0000 DCCY', 'memo field')
```

Examples of actions obtained on the chain are:

```
{
  "timestamp": "2019-11-20T02:20:05.000",
  "producer": "dccydccydccy",
  "confirmed": 0,
  "previous": "021472cd66b01c2ee4b43d2980713df90b4c6f67b025b32556e7177c1a130e64",
  "transaction_mroot": "a321fade674c1e0d0dbe0dadf003c38768356ce608874b79dde7ca4174330436",
  "action_mroot": "32e5ac06a722acad9d89ae068957e3e8aa83a114b739d7e728f8d04d57d267fe",
  "schedule_version": 334,
  "new_producers": null,
  "header_extensions": [],
  "producer_signature": "SIG_K1_KWgntpfkMjR52MC8NTJ4o6rE9pe3ZUEG7Q1ioFFRYfUBTcPYPDgucKVzZiCe293aU3yJhJMRR7pBBGwMasaQ4AbbK5KTjK",
  "transactions": [
    {
      "status": "executed",
      "cpu_usage_us": 568,
      "net_usage_words": 18,
      "trx": {
        "id": "183416881a4eb8e45da548d429eff1566d5416d6fb53cf5a5ec2f56e942a95e0",
        "signatures": [
          "SIG_K1_K7Qc7GbKyhpwaGKB8ZgtXKkk8ei2RJhBZ6vRTXrycSXYtNneyDpTes87vGGDP12EXkCBJjcXiVKfjBgig4neQinQkr7hqp"
        ],
        "compression": "none",
        "packed_context_free_data": "",
        "context_free_data": [],
        "packed_trx": "8fa3915c81712c0f4f49000000000100a6823403ea3055000000572d3ccdcd01504f520a514c8f5b00000000a8ed323233504f520a514c8f5b204408d3683f8dee817fcf000000000004464f0000000000125468616e6b7320666f7220737570706f727400",
        "transaction": {
          "expiration": "2019-11-20T02:21:03",
          "ref_block_num": 29057,
          "ref_block_prefix": 1229917996,
          "max_net_usage_words": 0,
          "max_cpu_usage_ms": 0,
          "delay_sec": 0,
          "context_free_actions": [],
          "actions": [
            {
              "account": "eosio.token",
              "name": "transfer",
              "authorization": [
                {
                  "actor": "accountfrom",
                  "permission": "active"
                }
              ],
              "data": {
                "from": "accountfrom",
                "to": "accountto",
                "quantity": "1.0000 DCCY",
                "memo": "memo field"
              },
              "hex_data": "504f520a514c8f5b204408d3683f8dee817fcf000000000004464f0000000000125468616e6b7320666f7220737570706f7274"
            }
          ],
          "transaction_extensions": []
        }
      }
    }
  ],
  "block_extensions": [],
  "id": "021472cefdf8687fcf4b21560c5d4b0d660eb499e40722bbaeea28b7c5d74c71",
  "block_num": 34894542,
  "ref_block_prefix": 1445022671
}
```

**extransfer：**

The `extransfer` function represents the transfer method extended with the DCCY main network. This method supports the transfer of all tokens issued on DCCY. The function prototype is:

```
void extransfer(account_name from, account_name to, extended_asset quantity, string memo)
```

Example:

> Transfer DCCY

```
extransfer('accountfrom', 'accountto', '1.0000 DCCY@eosio', 'memo field')
```

> Transfer DCNY or other tokens

```
extransfer('accountfrom', 'accountto', '1.0000 DCNY@dcny', 'memo field')
```

Among them, the @ character indicates the issuer of the token, the system token DCCY is DCCY @ eosio, DCNY is DCNY @ dcny, eosio indicates that the token is a system-issued token, and dccy indicates that the token The user issues a token.

Examples of actions obtained on the chain are:

```
{
  "timestamp": "2019-11-20T01:09:45.000",
  "producer": "dccydccydccy",
  "confirmed": 0,
  "previous": "021451fbb65c4e1e657eeea22de95dd3b78fc2c1a5dcd82e0eef87e594b63e43",
  "transaction_mroot": "803bd6b19aa480d78195fd950c336a60d2a6d03d6c9639b29b2023dea65cec7c",
  "action_mroot": "c5c7cf621fa707e37ef2cb4fe26f40217056583e92a6340b210708a365b0700b",
  "schedule_version": 334,
  "new_producers": null,
  "header_extensions": [],
  "producer_signature": "SIG_K1_KWgbyfa68s7XisFW37xA8RobkA9NZAVcdSqWRNmcyfkv1NdoZdg4Ux3phnLn713kYwLk8sAM2a8TFzJCyCvjyfy7HEA6yz",
  "transactions": [
    {
      "status": "executed",
      "cpu_usage_us": 524,
      "net_usage_words": 17,
      "trx": {
        "id": "7a3fcf6b41a314139004c523e051105761baa410727b7daf811c9a66d15d73d8",
        "signatures": [
          "SIG_K1_KAcz3Z2Yd7NCAdW4TA3RFLPESz6RJoNzjbF8SSpXtXxFWeDsYFb5AHob3TRDqNPM6NCUTzq3hT7FHNJ2VyaXwLYcEF42ek"
        ],
        "compression": "none",
        "packed_context_free_data": "",
        "context_free_data": [],
        "packed_trx": "0a93915c9a501d9a32be000000000100a6823403ea305500c0550b4f7373570130c455d85c95318d00000000a8ed32322930c455d85c95318d20c255d85c95318d102700000000000004464f00000000000000000000ea30550000",
        "transaction": {
          "expiration": "2019-11-20T01:10:34",
          "ref_block_num": 20634,
          "ref_block_prefix": 3190987293,
          "max_net_usage_words": 0,
          "max_cpu_usage_ms": 0,
          "delay_sec": 0,
          "context_free_actions": [],
          "actions": [
            {
              "account": "eosio.token",
              "name": "extransfer",
              "authorization": [
                {
                  "actor": "accountfrom",
                  "permission": "active"
                }
              ],
              "data": {
                "from": "accountfrom",
                "to": "accountto",
                "quantity": {
                  "quantity": "1.0000 DCCY",
                  "contract": "eosio"
                },
                "memo": "memo field"
              },
              "hex_data": "30c455d85c95318d20c255d85c95318d102700000000000004464f00000000000000000000ea305500"
            }
          ],
          "transaction_extensions": []
        }
      }
    }
  ],
  "block_extensions": [],
  "id": "021451fcb2c4621ffd29f10205e88e7d815f7e0952af0b1acbe2231cde4043bd",
  "block_num": 34886140,
  "ref_block_prefix": 49359357
}
```

> **note:**
> **The system token (DCCY) transfer supports the above two transfer methods, while the token issued by the project party only supports the second (extransfer) transfer method*

## Security guide for exchange deposits and withdrawals

This section summarizes a series of attacks that the exchange may encounter when connecting DCCY services, and provides corresponding security solutions.

### Irreversible height judgment

Because the DCCY public chain uses the DPOS consensus mechanism, in determining whether a transfer (a transaction) is credible, it is necessary to judge the height of the block where the current transfer action is located. In the DCCY network, if the height of an exchange is within the irreversible height, we can assume that the transaction has been confirmed by the BP (Block Producer) node in the DCCY network, entered an irreversible state, and cannot be rolled back.

Therefore, when the exchange determines whether a user deposit transaction is valid, it is necessary to determine that the height of the transfer is less than the current irreversible height of DCCY. To obtain the irreversible height of DCCY, you can obtain the basic information on the chain through the fibos.js client or RPC:

```
{
    "server_version": "14a65aca",
    "chain_id": "22d49c00e4a603cbd283d7d274d2ae82ebf4e286dd5faa09a4e0f436bef7129d",
    "head_block_num": 21454485,
    "last_irreversible_block_num": 21454149,
    "last_irreversible_block_id": "01475d459bafc69dd1f0dc379aecee0dad4679a6f138466e08d2328a4556b1db",
    "head_block_id": "01475e95ee8421e0e360e9a331a1a2cf03e8bec2d472f6009b5d52b23e5445fd",
    "head_block_time": "2019-12-12T09:56:41.500",
    "head_block_producer": "genesisnodej",
    "virtual_block_cpu_limit": 200000000,
    "virtual_block_net_limit": 1048576000,
    "block_cpu_limit": 199900,
    "block_net_limit": 1048576,
    "server_version_string": "v1.0-DCCY"
}
```

The `last_irreversible_block_num` field indicates the current latest irreversible height of the DCCY network.

It takes approximately 164 seconds for a transaction to change from being packaged into a block to an irreversible state, so this time is the delay time for the user to recharge the account.

### "Fake currency" recharge

Because many users on the DCCY public chain have issued their own tokens, if the exchange's business is not handled carefully, it will lead to the recharging of tokens issued by users to enter the exchange to participate in transactions. "For such counterfeit currency recharge behavior, the exchange needs to take precautions in the recharge business.

For `transfer` transfer (action.name is transfer), the example is as follows:

```
"actions": [
    {
      "account": "eosio.token",
      "name": "transfer",
      "authorization": [
        {
          "actor": "accountfrom",
          "permission": "active"
        }
      ],
      "data": {
        "from": "accountfrom",
        "to": "accountto",
        "quantity": "1.0000 DCCY",
        "memo": "memo field"
      },
      "hex_data": "504f520a514c8f5b204408d3683f8dee817fcf000000000004464f0000000000125468616e6b7320666f7220737570706f7274"
    }
  ]
```

需要判断：

- `action.account` must be‘ eosio.token ’
- `actions.data.to` Must recharge the account name
- `actions.data.quantity` must be‘ xxx.xxxx DCCY ’

For an `extransfer` transfer (action.name is extransfer), the example is as follows:

```
"actions": [
   {
     "account": "eosio.token",
     "name": "extransfer",
     "authorization": [
       {
         "actor": "accountfrom",
         "permission": "active"
       }
     ],
     "data": {
       "from": "accountfrom",
       "to": "accountto",
       "quantity": {
         "quantity": "1.0000 DCCY",
         "contract": "eosio"
       },
       "memo": "memo field"
     },
     "hex_data": "30c455d85c95318d20c255d85c95318d102700000000000004464f00000000000000000000ea305500"
   }
 ]
```

When judging the DCCY recharge, the following judgments need to be made:

- `action.account` must be‘ eosio.token ’
- `actions.data.to` must be a deposit account name for the exchange
- `actions.data.quantity` must be‘ xxx.xxxx DCCY ’// DCCY is the target token 
- `actions.data.quantity.contract` must be‘ eosio ’// eosio is the token project party

When judging DCNY or other token recharge, the following judgments need to be made

- `action.account` must be‘ eosio.token ’
- `actions.data.to` must be a deposit account name for the exchange
- `actions.data.quantity` must be‘ xxx.xxxx DCNY ’/ DCNY as the target token. When judging other tokens, it should be the token name
- `actions.data.quantity.contract` must be‘ dcny ’// dcny is the name of the token project party, when judging other tokens, it should be the name of the other token project party

### Hard-failed status attack

There are multiple execution states of transactions on the DCCY chain, one of which is hard-failed. The characteristics of transactions in this state are that they have not been successfully executed, but they still have a record on the chain that an attacker can use. This trading characteristic of DCCY poses a threat to the exchange, thus performing false recharge. The defense against this security threat is to judge the status of the transaction on the basis of the irreversible height. If the status of the recharge transaction is found to be `hard-failed ', it is deemed to be a fake recharge. For the following example transactions, the exchange should judge: ** transactions.status ** is ** executed **. Only transactions that are in the state of `executed` and are already at an irreversible height can be considered as true and immutable recharge records.

```
{
  "timestamp": "2019-11-20T01:09:45.000",
  "producer": "dccydccydccy",
  "confirmed": 0,
  "previous": "021451fbb65c4e1e657eeea22de95dd3b78fc2c1a5dcd82e0eef87e594b63e43",
  "transaction_mroot": "803bd6b19aa480d78195fd950c336a60d2a6d03d6c9639b29b2023dea65cec7c",
  "action_mroot": "c5c7cf621fa707e37ef2cb4fe26f40217056583e92a6340b210708a365b0700b",
  "schedule_version": 334,
  "new_producers": null,
  "header_extensions": [],
  "producer_signature": "SIG_K1_KWgbyfa68s7XisFW37xA8RobkA9NZAVcdSqWRNmcyfkv1NdoZdg4Ux3phnLn713kYwLk8sAM2a8TFzJCyCvjyfy7HEA6yz",
  "transactions": [
    {
      "status": "executed",
      "cpu_usage_us": 524,
      "net_usage_words": 17,
      "trx": {
        "id": "7a3fcf6b41a314139004c523e051105761baa410727b7daf811c9a66d15d73d8",
        "signatures": [
          "SIG_K1_KAcz3Z2Yd7NCAdW4TA3RFLPESz6RJoNzjbF8SSpXtXxFWeDsYFb5AHob3TRDqNPM6NCUTzq3hT7FHNJ2VyaXwLYcEF42ek"
        ],
        "compression": "none",
        "packed_context_free_data": "",
        "context_free_data": [],
        "packed_trx": "0a93915c9a501d9a32be000000000100a6823403ea305500c0550b4f7373570130c455d85c95318d00000000a8ed32322930c455d85c95318d20c255d85c95318d102700000000000004464f00000000000000000000ea30550000",
        "transaction": {
          "expiration": "2019-11-20T01:10:34",
          "ref_block_num": 20634,
          "ref_block_prefix": 3190987293,
          "max_net_usage_words": 0,
          "max_cpu_usage_ms": 0,
          "delay_sec": 0,
          "context_free_actions": [],
          "actions": [
            {
              "account": "eosio.token",
              "name": "extransfer",
              "authorization": [
                {
                  "actor": "accountfrom",
                  "permission": "active"
                }
              ],
              "data": {
                "from": "accountfrom",
                "to": "accountto",
                "quantity": {
                  "quantity": "1.0000 DCCY",
                  "contract": "eosio"
                },
                "memo": "memo field"
              },
              "hex_data": "30c455d85c95318d20c255d85c95318d102700000000000004464f00000000000000000000ea305500"
            }
          ],
          "transaction_extensions": []
        }
      }
    }
  ],
  "block_extensions": [],
  "id": "021451fcb2c4621ffd29f10205e88e7d815f7e0952af0b1acbe2231cde4043bd",
  "block_num": 34886140,
  "ref_block_prefix": 49359357
}
```

## DCCY node security configuration

For the exchange, the security of the DCCY node can not be ignored. In the exchange, the DCCY API node carries the function of depositing money and operating the withdrawal operation. Once the security problem occurs, the loss may be inestimable. of. This part of the content provides some guidance for the exchange to build a secure and reliable DCCY network node.

### Node configuration

In order to meet the exchange deposit and withdrawal business, the physical configuration of the DCCY node machine is recommended as follows:

|               | Recommended              | Minimum configuration    |
| :-------      | :----------------------- | :----------------------- |
| System type   | Ubuntu Server 16.04+,X64 | Ubuntu Server 16.04+,X64 |
| CPU           | 4 Nuclear                | 2 Nuclear                |
| RAM           | 8GB                      | 4GB                      |
| hard disk     | 300GB + （SSD）          | 100GB + （SSD）          |

### RPC security

Exchange API nodes recommend disabling external network RPC. If the nodes require RPC access, it is recommended to use intranet HTTP. The corresponding configuration example code is as follows:

```
fibos.load("http", {
  "http-server-address": "127.0.0.1:8870", //Intranet RPC address and port 
});
```